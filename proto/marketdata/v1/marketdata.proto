syntax = "proto3";

package marketdata.v1;

option go_package = "github.com/ArcaTechCo/PipsendProtos/gen/go/marketdata/v1;marketdatav1";

// MarketData service provides real-time and cached market data access
service MarketData {
  // GetTopOfBook returns the current best bid/ask for a symbol
  rpc GetTopOfBook(GetTopOfBookRequest) returns (GetTopOfBookResponse);
  
  // GetMarkPrice returns the current mark price for a symbol
  rpc GetMarkPrice(GetMarkPriceRequest) returns (GetMarkPriceResponse);
  
  // Convert performs currency conversion between two symbols
  rpc Convert(ConvertRequest) returns (ConvertResponse);
  
  // GetSymbol returns a symbol by its ID
  rpc GetSymbol(GetSymbolRequest) returns (GetSymbolResponse);
  
  // GetSymbolByCode returns a symbol by its code
  rpc GetSymbolByCode(GetSymbolByCodeRequest) returns (GetSymbolResponse);
  
  // ListSymbols returns a list of symbols with optional active filter
  rpc ListSymbols(ListSymbolsRequest) returns (ListSymbolsResponse);
  
  // GetTradingSessions returns trading sessions for a symbol
  rpc GetTradingSessions(GetTradingSessionsRequest) returns (GetTradingSessionsResponse);
  
  // GetHistoricalCandles streams historical OHLC candles for a symbol
  rpc GetHistoricalCandles(GetHistoricalCandlesRequest) returns (stream GetHistoricalCandlesResponse);
  
  // GetHistoricalTicks streams historical tick data (bid/ask) for a symbol
  rpc GetHistoricalTicks(GetHistoricalTicksRequest) returns (stream GetHistoricalTicksResponse);
  
  // GetSymbolInfo returns detailed symbol information for trading
  rpc GetSymbolInfo(GetSymbolInfoRequest) returns (GetSymbolInfoResponse);
  
  // GetProvider returns a provider by ID
  rpc GetProvider(GetProviderRequest) returns (GetProviderResponse);
  
  // ListProviders returns a list of providers with optional filters
  rpc ListProviders(ListProvidersRequest) returns (ListProvidersResponse);
}

// GetTopOfBookRequest requests top of book data for a symbol
message GetTopOfBookRequest {
  string symbol = 1; // Symbol code (e.g., "BTCUSD")
}

// GetTopOfBookResponse returns bid/ask prices with timestamp
message GetTopOfBookResponse {
  string symbol = 1;           // Symbol code
  string bid = 2;              // Bid price as decimal string
  string ask = 3;              // Ask price as decimal string
  int64 ts_unix_ms = 4;        // Timestamp in Unix milliseconds
  string source = 5;           // Data source (CACHE, DB, COMPUTED)
}

// GetMarkPriceRequest requests mark price for a symbol
message GetMarkPriceRequest {
  string symbol = 1; // Symbol code (e.g., "BTCUSD")
}

// GetMarkPriceResponse returns mark price with timestamp
message GetMarkPriceResponse {
  string symbol = 1;           // Symbol code
  string mark_price = 2;       // Mark price as decimal string
  int64 ts_unix_ms = 3;        // Timestamp in Unix milliseconds
  string source = 4;           // Data source (CACHE, DB, COMPUTED)
  string method = 5;           // Pricing method (MID, LAST, WEIGHTED)
}

// ConvertRequest requests currency conversion
message ConvertRequest {
  string amount = 1;           // Amount to convert as decimal string
  string from = 2;             // Source currency code
  string to = 3;               // Target currency code
}

// ConvertResponse returns converted amount with rate
message ConvertResponse {
  string amount = 1;           // Original amount
  string from = 2;             // Source currency
  string to = 3;               // Target currency
  string converted_amount = 4; // Converted amount as decimal string
  string rate = 5;             // Exchange rate as decimal string
  int64 ts_unix_ms = 6;        // Timestamp in Unix milliseconds
  string path = 7;             // Conversion path (DIRECT, VIA_USD)
}

// GetSymbolRequest requests a symbol by ID
message GetSymbolRequest {
  int64 symbol_id = 1; // Symbol ID
}

// GetSymbolByCodeRequest requests a symbol by code
message GetSymbolByCodeRequest {
  string code = 1; // Symbol code (e.g., "ETHUSD", "BTCUSD")
}

// ListSymbolsRequest requests a list of symbols
message ListSymbolsRequest {
  bool active_only = 1; // true = only active symbols, false = all symbols
}

// MarketRouteInfo represents a routing configuration for a symbol to a specific provider
message MarketRouteInfo {
  uint32 provider_id = 1;   // Provider ID (e.g., 3 for PrimeXM)
  string symbol_code = 2;   // Provider-specific symbol code (e.g., "BTCUSD.i", "XAUUSD.i")
  int32 priority = 3;       // Route priority (lower number = higher priority)
  bool is_active = 4;       // Whether this route is active
}

// SymbolInfo contains complete symbol configuration
message SymbolInfo {
  int64 id = 1;                   // Symbol ID
  string code = 2;                // Symbol code: "ETHUSD", "BTCUSD", etc.
  string name = 3;                // Symbol name/description
  string contract_size = 4;       // Contract size: "1", "100000"
  int32 digits = 5;               // Decimal places: 2, 5, etc.
  string tick_size = 6;           // Tick size: "0.01", "0.00001"
  string min_trade_size = 7;      // Minimum trade size: "0.01"
  string max_trade_size = 8;      // Maximum trade size: "100.00"
  string volume_step = 9;         // Volume step: "0.01"
  string required_margin = 10;    // Required margin: "0.01" (1%)
  string quote_currency = 11;     // Quote currency: "USD"
  string base_currency = 12;      // Base currency: "ETH", "BTC"
  bool is_active = 13;            // Whether the symbol is active
  string point_value = 14;        // Point value: "10.00" (value per point movement)
  MarketRouteInfo market_route = 15;  // Market route to provider (null if no route exists)
}

// GetSymbolResponse returns a single symbol
message GetSymbolResponse {
  SymbolInfo symbol = 1;
}

// ListSymbolsResponse returns a list of symbols
message ListSymbolsResponse {
  repeated SymbolInfo symbols = 1;
}

// GetTradingSessionsRequest requests trading sessions for a symbol
message GetTradingSessionsRequest {
  int64 symbol_id = 1; // Symbol ID
}

// TradingSession represents a single trading session window
message TradingSession {
  int32 day_of_week = 1;     // 0=Sunday, 1=Monday, ..., 6=Saturday
  string open_time = 2;      // "09:30:00" (HH:MM:SS format)
  string close_time = 3;     // "16:00:00" (HH:MM:SS format)
  int32 session_number = 4;  // 1, 2, 3... (for multiple sessions per day)
}

// GetTradingSessionsResponse returns trading sessions for a symbol
message GetTradingSessionsResponse {
  bool is_24_7 = 1;                      // true if market operates 24/7
  string timezone = 2;                   // "America/New_York", "UTC", etc.
  string symbol_code = 3;                // "AAPL", "EURUSD", etc.
  repeated TradingSession sessions = 4;  // List of trading sessions
  string source = 5;                     // "SYMBOL_ONLY", "PROVIDER_ONLY", "INTERSECTION", "24_7"
}

// ========== Historical Data Messages ==========

// GetHistoricalCandlesRequest requests historical OHLC candles
message GetHistoricalCandlesRequest {
  int64 symbol_id = 1;    // Symbol ID from database
  string timeframe = 2;   // Timeframe: "M1", "M5", "M15", "M30", "H1", "H4", "D1", "W1", "MN"
  int64 from_time = 3;    // Start timestamp (Unix seconds)
  int64 to_time = 4;      // End timestamp (Unix seconds)
}

// GetHistoricalCandlesResponse streams individual candles
message GetHistoricalCandlesResponse {
  int64 time = 1;      // Candle timestamp (Unix seconds)
  double open = 2;     // Open price
  double high = 3;     // High price
  double low = 4;      // Low price
  double close = 5;    // Close price
  int64 volume = 6;    // Volume (0 if not available)
}

// GetHistoricalTicksRequest requests historical tick data
message GetHistoricalTicksRequest {
  int64 symbol_id = 1;    // Symbol ID from database
  int64 from_time = 2;    // Start timestamp (Unix seconds)
  int64 to_time = 3;      // End timestamp (Unix seconds)
}

// GetHistoricalTicksResponse streams individual ticks
message GetHistoricalTicksResponse {
  int64 time = 1;      // Tick timestamp (Unix seconds)
  double bid = 2;      // Bid price
  double ask = 3;      // Ask price
}

// GetSymbolInfoRequest requests detailed symbol information
message GetSymbolInfoRequest {
  int64 symbol_id = 1;    // Symbol ID from database
}

// SymbolInfoDetailed contains complete trading symbol information
message SymbolInfoDetailed {
  int64 symbol_id = 1;           // Symbol ID
  string symbol_name = 2;        // Symbol name/code (e.g., "EURUSD")
  double contract_size = 3;      // Contract size (e.g., 100000 for forex)
  int32 digits = 4;              // Number of decimal places (e.g., 5 for EURUSD)
  double point = 5;              // Point value (e.g., 0.00001)
  double tick_size = 6;          // Minimum tick size
  double tick_value = 7;         // Value of one tick
  double spread = 8;             // Current spread
  double min_trade_size = 9;     // Minimum trade size
  double max_trade_size = 10;    // Maximum trade size
  double required_margin = 11;   // Required margin percentage
  string asset_type = 12;        // Asset type: "forex", "crypto", "stock", etc.
}

// GetSymbolInfoResponse returns detailed symbol information
message GetSymbolInfoResponse {
  SymbolInfoDetailed symbol = 1;
}

// ========== Provider Management Messages ==========

// Provider represents a market data or trading provider configuration
message Provider {
  uint32 id = 1;                          // Provider ID
  string name = 2;                        // Provider name: "Polygon", "PrimeXM", etc.
  string type = 3;                        // Provider type: "fix", "simulator", "websocket", "rest_api"
  string status = 4;                      // Provider status: "active", "inactive"
  string capabilities = 5;                // Provider capabilities: "pricing", "trading", "both"
  string metadata = 6;                    // Configuration metadata as JSON string
  string connection_mode = 7;             // Connection mode: "fix", "websocket", etc.
  bool is_active = 8;                     // Whether the provider is active
  string connect_policy = 9;              // Connection policy: "always", "on_demand", "during_session"
  int32 heartbeat_timeout_sec = 10;       // Heartbeat timeout in seconds
  int32 backoff_base_sec = 11;            // Base backoff in seconds for reconnection
  int32 max_backoff_sec = 12;             // Maximum backoff in seconds
  bool resubscribe_on_reconnect = 13;     // Auto-resubscribe on reconnect
}

// GetProviderRequest requests a provider by ID
message GetProviderRequest {
  uint32 provider_id = 1;  // Provider ID to retrieve
}

// GetProviderResponse returns a single provider
message GetProviderResponse {
  Provider provider = 1;
}

// ListProvidersRequest requests a list of providers with optional filters
message ListProvidersRequest {
  optional string type = 1;           // Filter by type: "fix", "simulator", "websocket"
  optional string capabilities = 2;   // Filter by capabilities: "pricing", "trading", "both"
  optional string status = 3;         // Filter by status: "active", "inactive"
  int32 page = 4;                     // Page number (default: 1)
  int32 page_size = 5;                // Page size (default: 50)
}

// ListProvidersResponse returns a list of providers
message ListProvidersResponse {
  repeated Provider providers = 1;    // List of providers
  int32 total = 2;                    // Total number of providers
  int32 page = 3;                     // Current page
  int32 page_size = 4;                // Page size
}
